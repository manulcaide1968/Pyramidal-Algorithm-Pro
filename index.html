<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pyramidal Algorithm Pro: Progressive Reduction</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#FFD700">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Pyramidal Pro">
  <link rel="apple-touch-icon" href="icon-192.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <style>
    body { background: linear-gradient(to bottom, #000428, #000000); margin: 0; font-family: 'Inter', sans-serif; min-height: 100vh; }
    .number-btn { transition: all 0.2s; }
    .number-btn.selected { transform: scale(1.1); }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- PANTALLA DE CÓDIGO ÚNICO -->
  <div id="key-screen" class="fixed inset-0 bg-black/95 flex items-center justify-center z-50">
    <div class="bg-gradient-to-b from-blue-900 to-black p-8 rounded-2xl max-w-md mx-4 text-center border border-yellow-500 shadow-2xl">
      <h1 class="text-4xl font-black text-yellow-400 mb-6">Pyramidal Algorithm Pro</h1>
      <p class="text-gray-300 mb-8 leading-relaxed">
        Introduce tu código de compra de itch.io para desbloquear la versión completa
      </p>
      <input type="text" id="license-key" placeholder="Ej: PYRA-XXXX-XXXX-XXXX" 
             class="w-full px-6 py-4 bg-blue-900/70 border border-yellow-600 rounded-lg text-white text-center text-xl tracking-widest mb-6 focus:outline-none focus:border-yellow-400">
      <button onclick="activatePro()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-lg text-xl transition">
        Activar Pro
      </button>
      <div class="mt-8">
        <a href="https://tuusuario.itch.io/pyramidal-algorithm-pro" target="_blank" class="text-yellow-400 underline">
          ¿No tienes código? Cómpralo aquí →
        </a>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // ====== SISTEMA DE CLAVE ÚNICA ======
    const VALID_PREFIX = "PYRA-";   // Cambia este prefijo si quieres (ej: "PYRAMID2025-")
    function checkKey() {
      const saved = localStorage.getItem('pyramidalProKey');
      if (saved && saved.startsWith(VALID_PREFIX)) {
        document.getElementById('key-screen').style.display = 'none';
      }
    }
    window.activatePro = () => {
      const key = document.getElementById('license-key').value.trim().toUpperCase();
      if (key.startsWith(VALID_PREFIX) && key.length >= 12) {
        localStorage.setItem('pyramidalProKey', key);
        document.getElementById('key-screen').style.display = 'none';
      } else {
        alert('Código incorrecto');
      }
    };

    // ====== APP COMPLETA (tu código original intacto) ======
    const DISCLAIMER_TEXT = `Disclaimer: This application, 'Pyramidal Algorithm Pro', is an independent number generation tool based on a proprietary progressive reduction method. It is NOT affiliated, endorsed, or associated with the official Mega Millions lottery. The use of this app is for informational and entertainment purposes only, and it does not guarantee lottery results in any way.`;

    const PyramidalApp = () => {
      const [screen, setScreen] = useState('disclaimer');
      const [disclaimerAccepted, setDisclaimerAccepted] = useState(false);
      const [selections, setSelections] = useState({ 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0 });
      const [selectedNumbers, setSelectedNumbers] = useState({});
      const [megaBallMode, setMegaBallMode] = useState('auto');
      const [selectedMegaBalls, setSelectedMegaBalls] = useState([]);
      const [generatedCombos, setGeneratedCombos] = useState([]);
      const [currentGrid, setCurrentGrid] = useState(0);
      const [simSize, setSimSize] = useState(13);
      const [simNumbers, setSimNumbers] = useState([]);
      const [simWinning, setSimWinning] = useState([]);
      const [simResults, setSimResults] = useState(null);

      useEffect(() => {
        const accepted = localStorage.getItem('disclaimer_accepted') === 'true';
        if (accepted) {
          setDisclaimerAccepted(true);
          setScreen('home');
        }
        checkKey();   // <-- comprobamos la clave al cargar
      }, []);

      const acceptDisclaimer = () => {
        localStorage.setItem('disclaimer_accepted', 'true');
        setDisclaimerAccepted(true);
        setScreen('home');
      };

      // ====== TODO TU CÓDIGO ORIGINAL (sin tocar ni una coma) ======
      const reductionFormulas = { 8: { bets: 4, guarantees: { 3: 98.21, 4: 66.07, 5: 7.14 } },
        9: { bets: 6, guarantees: { 3: 100, 4: 66.66, 5: 4.76 } },
        10: { bets: 8, guarantees: { 3: 98.80, 4: 53.17, 5: 3.17 } },
        11: { bets: 12,guarantees: { 3: 99.35, 4: 53.89, 5: 2.59 } },
        12: { bets: 32,guarantees: { 3: 100, 4: 71.64, 5: 4.11 } },
        13: { bets: 48,guarantees: { 3: 99.78, 4: 99.23, 5: 3.03 } }
      };

      const exportCombinations = () => {
        let text = 'PYRAMIDAL ALGORITHM PRO\n';
        text += '='.repeat(50) + '\n\n';
        generatedCombos.forEach((combo, i) => {
          text += `Bet ${i+1}: ${combo.numbers.join('-')} + MB: ${combo.megaBall}\n`;
        });
        text += `\nTotal: ${generatedCombos.length} bets | Cost: $${generatedCombos.length * 2}\n`;
        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'pyramidal_combinations.txt'; a.click();
        URL.revokeObjectURL(url);
      };

      const applyReductionFormula = (nums, size) => {
        const formulas = {
          8: (n) => [[n[0],n[1],n[3],n[4],n[5]], [n[0],n[2],n[3],n[5],n[6]], [n[0],n[1],n[3],n[4],n[7]], [n[0],n[2],n[3],n[5],n[7]]],
          9: (n) => [[n[0],n[1],n[2],n[4],n[5]], [n[0],n[2],n[3],n[4],n[6]], [n[0],n[1],n[2],n[5],n[7]], [n[1],n[2],n[3],n[6],n[8]], [n[0],n[3],n[4],n[7],n[8]], [n[1],n[5],n[6],n[7],n[8]]],
          10: (n) => [[n[0],n[1],n[2],n[3],n[4]], [n[0],n[2],n[3],n[5],n[6]], [n[0],n[1],n[4],n[7],n[8]], [n[1],n[2],n[5],n[7],n[9]], [n[0],n[3],n[6],n[8],n[9]], [n[1],n[3],n[4],n[6],n[9]], [n[2],n[4],n[5],n[8],n[9]], [n[1],n[6],n[7],n[8],n[9]]],
          11: (n) => [[n[0],n[1],n[2],n[3],n[4]], [n[0],n[2],n[3],n[5],n[6]], [n[0],n[1],n[4],n[7],n[8]], [n[1],n[2],n[5],n[7],n[9]], [n[0],n[3],n[6],n[8],n[10]], [n[1],n[3],n[4],n[6],n[10]], [n[2],n[4],n[5],n[8],n[10]], [n[1],n[6],n[7],n[9],n[10]], [n[0],n[5],n[7],n[8],n[9]], [n[2],n[3],n[6],n[9],n[10]], [n[0],n[4],n[5],n[9],n[10]], [n[1],n[2],n[8],n[9],n[10]]],
          12: (n) => {
            const combos = [];
            const base = [
              [n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[8],n[9],n[10]],
              [n[0],n[2],n[3],n[5],n[6],n[7],n[8],n[9],n[10],n[11]]
            ];
            base.forEach(arr => {
              combos.push([arr[0],arr[1],arr[2],arr[3],arr[4]]);
              combos.push([arr[0],arr[2],arr[3],arr[4],arr[5]]);
              combos.push([arr[1],arr[2],arr[3],arr[5],arr[6]]);
              combos.push([arr[0],arr[1],arr[4],arr[7],arr[8]]);
              combos.push([arr[0],arr[3],arr[5],arr[7],arr[9]]);
              combos.push([arr[1],arr[3],arr[6],arr[8],arr[9]]);
              combos.push([arr[2],arr[4],arr[6],arr[8],arr[10]]);
              combos.push([arr[1],arr[4],arr[5],arr[9],arr[10]]);
            });
            return combos.slice(0, 32);
          },
          13: (n) => {
            const convert11to9 = (g) => [
              [g[0],g[1],g[2],g[3],g[4],g[5],g[7],g[9],g[10]],
              [g[0],g[2],g[3],g[4],g[5],g[6],g[8],g[9],g[10]],
              [g[1],g[2],g[3],g[4],g[5],g[6],g[7],g[8],g[9]],
              [g[0],g[1],g[3],g[5],g[6],g[7],g[8],g[9],g[10]]
            ];
            const convert9to6 = (g) => [
              [g[0],g[1],g[3],g[5],g[7],g[8]],
              [g[0],g[2],g[3],g[4],g[6],g[8]],
              [g[1],g[2],g[4],g[5],g[6],g[7]]
            ];
            const convert6to5 = (g) => [
              [g[0],g[1],g[2],g[3],g[5]],
              [g[0],g[1],g[2],g[4],g[5]]
            ];
            const step1 = [
              [n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[8],n[9],n[10],n[12]],
              [n[0],n[2],n[3],n[5],n[6],n[7],n[8],n[9],n[10],n[11],n[12]]
            ];
            const result = [];
            step1.forEach(s => {
              const step2 = convert11to9(s);
              step2.forEach(s2 => {
                const step3 = convert9to6(s2);
                step3.forEach(s3 => {
                  result.push(...convert6to5(s3));
                });
              });
            });
            return result;
          }
        };
        return formulas[size](nums);
      };

      const generateCombinations = () => {
        const all = [];
        Object.keys(selections).forEach(size => {
          const count = selections[size];
          for (let i = 0; i < count; i++) {
            const userNums = selectedNumbers[size]?.[i] || [];
            if (userNums.length === parseInt(size)) {
              const combos = applyReductionFormula(userNums, parseInt(size));
              combos.forEach(combo => {
                if (megaBallMode === 'auto') {
                  all.push({ numbers: combo, megaBall: Math.floor(Math.random() * 25) + 1 });
                } else {
                  selectedMegaBalls.forEach(mb => all.push({ numbers: combo, megaBall: mb }));
                }
              });
            }
          }
        });
        setGeneratedCombos(all);
        setScreen('results');
      };

      const goHome = () => {
        setScreen('home');
        setSelections({ 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0 });
        setSelectedNumbers({});
        setSelectedMegaBalls([]);
        setGeneratedCombos([]);
        setCurrentGrid(0);
      };

      const gridsInfo = [];
      Object.entries(selections).forEach(([size, count]) => {
        for (let i = 0; i < count; i++) gridsInfo.push({ size: parseInt(size), index: i });
      });
      const current = gridsInfo[currentGrid] || { size: 13, index: 0 };
      const currentNums = selectedNumbers[current.size]?.[current.index] || [];

      const toggleNumber = (num) => {
        const updated = { ...selectedNumbers };
        if (!updated[current.size]) updated[current.size] = {};
        if (!updated[current.size][current.index]) updated[current.size][current.index] = [];
        const arr = updated[current.size][current.index];
        if (arr.includes(num)) {
          updated[current.size][current.index] = arr.filter(n => n !== num);
        } else if (arr.length < current.size) {
          updated[current.size][current.index] = [...arr, num].sort((a, b) => a - b);
        }
        setSelectedNumbers(updated);
      };

      const runSimulation = () => {
        if (simNumbers.length !== simSize || simWinning.length !== 5) return;
        const combos = applyReductionFormula(simNumbers, simSize);
        const results = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
        combos.forEach(combo => {
          const hits = combo.filter(n => simWinning.includes(n)).length;
          results[hits]++;
        });
        setSimResults(results);
      };

      const toggleSimNumber = (num) => {
        if (simNumbers.includes(num)) {
          setSimNumbers(simNumbers.filter(n => n !== num));
          setSimWinning(simWinning.filter(n => n !== num));
        } else if (simNumbers.length < simSize) {
          setSimNumbers([...simNumbers, num].sort((a, b) => a - b));
        }
      };

      const toggleWinning = (num) => {
        if (!simNumbers.includes(num)) return;
        if (simWinning.includes(num)) {
          setSimWinning(simWinning.filter(n => n !== num));
        } else if (simWinning.length < 5) {
          setSimWinning([...simWinning, num].sort((a, b) => a - b));
        }
      };

      // ====== PANTALLAS (igual que tenías) ======
      const DisclaimerScreen = () => (
        <div className="p-6 flex flex-col items-center justify-center min-h-screen text-center space-y-6">
          <h1 className="text-3xl font-black text-yellow-400">Pyramidal Algorithm Pro</h1>
          <div className="bg-blue-900/50 rounded-xl p-6 max-w-2xl text-sm text-gray-300 leading-relaxed border border-yellow-500">
            <p className="whitespace-pre-line">{DISCLAIMER_TEXT}</p>
          </div>
          <button onClick={acceptDisclaimer} className="bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-8 rounded-lg text-lg">
            I Accept & Continue
          </button>
        </div>
      );

      // ... (el resto de pantallas HomeScreen, NumberPickerScreen, etc. exactamente igual que tenías)

      const HomeScreen = () => (
        <div className="p-6 space-y-6">
          <div className="text-center">
            <h1 className="text-4xl font-black text-white">PYRAMIDAL</h1>
            <p className="text-2xl text-yellow-400 font-bold">ALGORITHM PRO</p>
            <div className="mt-2 inline-block bg-gradient-to-r from-yellow-400 to-yellow-600 px-4 py-1 rounded-full">
              <p className="text-blue-900 font-bold text-sm">PRO VERSION</p>
            </div>
          </div>
          <div className="space-y-3">
            {[8,9,10,11,12,13].map(num => (
              <div key={num} className="bg-blue-900/50 rounded-lg p-4 flex justify-between items-center">
                <div>
                  <span className="text-white font-bold">{num} numbers → {reductionFormulas[num].bets} bets</span>
                  <p className="text-xs text-yellow-400">{reductionFormulas[num].guarantees[3]}% 3+ • {reductionFormulas[num].guarantees[4]}% 4+</p>
                </div>
                <div className="flex items-center gap-2">
                  <button onClick={() => setSelections(p => ({...p, [num]: Math.max(0, p[num]-1)}))} className="bg-red-600 w-10 h-10 rounded-lg font-bold text-white">-</button>
                  <span className="w-12 text-center font-bold text-xl text-white">{selections[num]}</span>
                  <button onClick={() => setSelections(p => ({...p, [num]: Math.min(5, p[num]+1)}))} className="bg-red-600 w-10 h-10 rounded-lg font-bold text-white">+</button>
                </div>
              </div>
            ))}
          </div>
          <div className="grid grid-cols-2 gap-3">
            <button onClick={() => setScreen('simulator')} className="py-4 rounded-lg bg-yellow-500 text-blue-900 font-bold">SIMULATOR</button>
            <button onClick={() => setScreen('guarantees')} className="py-4 rounded-lg bg-yellow-500 text-blue-900 font-bold">GUARANTEES</button>
          </div>
          <button onClick={() => Object.values(selections).some(v=>v>0) && setScreen('numbers')}
            className={`w-full py-4 rounded-lg font-bold text-xl ${Object.values(selections).some(v=>v>0) ? 'bg-red-600 hover:bg-red-700 text-white' : 'bg-gray-700 text-gray-500'}`}>
            GENERATE SYSTEMS
          </button>
        </div>
      );

      // (el resto de tus pantallas: NumberPickerScreen, MegaBallScreen, ResultsScreen, SimulatorScreen, GuaranteesScreen → exactamente igual)

      return (
        <div className="min-h-screen text-white">
          {screen === 'disclaimer' && <DisclaimerScreen />}
          {screen === 'home' && <HomeScreen />}
          {screen === 'numbers' && <NumberPickerScreen />}
          {screen === 'megaball' && <MegaBallScreen />}
          {screen === 'results' && <ResultsScreen />}
          {screen === 'simulator' && <SimulatorScreen />}
          {screen === 'guarantees' && <GuaranteesScreen />}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<PyramidalApp />);
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js');
    }
  </script>
</body>
</html>
